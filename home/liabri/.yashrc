# colours
alias grep="grep --color=auto"
alias ls="ls --color=auto"

# aliases
alias cp="cp -i"                        # confirm before overwriting something
alias rm="rm -i"                        # confirm before deleting something
alias df="df -h"                        # human-readable sizes
alias free="free -m"                    # show sizes in MB
alias feo="fastfetch"
alias doc="zathura --fork"

# pass
pass(){ [[ "$1" == "otp" ]] && shift && command pass otp -c "$@" || ([[ "$1" == "-c" || "$1" == "--clip" ]] && command pass "$@" || command pass -c "$@"); }

# git
alias ga="git add"
alias gp="git push -u origin master"
alias gs="git status"
alias gc="git commit -m"
alias gaa="git add -A"
alias gpf="git push -f"
alias gcm="git commit -m"
alias gca="git commit --amend"
alias gl="git log --all --decorate --oneline --graph"

# nix
alias rebuild="sudo nixos-rebuild switch --flake /etc/nixos#liabri"     # rebuild system permenantly
alias rebuild-test="sudo nixos-rebuild test --flake /etc/nixos#liabri"  # rebuild system w/o boot entry
alias nixcon="sudo nano /etc/nixos/configuration.nix"                   # edit /etc/nixos/configuration.nix
alias flake="sudo nano /etc/nixos/flake.nix"                            # edit /etc/nixos/flake.nix

function ins() {
    if [ -z "$1" ]; then echo "Usage: ins <package>"; return 1; fi

    local SESSION_PROF="$HOME/.local/state/nix/profiles/session" # installation location
    local WRAPPERS_DIR="$HOME/.cache/nix-session/wrappers" # wrapper scripts defining XDG vars for the binaries
    local BEFORE="" # binaries before install
    if [ -d "$SESSION_PROF/bin" ]; then
        for f in "$SESSION_PROF/bin"/*; do
            [ -f "$f" ] && BEFORE="$BEFORE $(basename "$f")"
        done
    fi

    mkdir -p "$WRAPPERS_DIR" \
             "$HOME/.cache/nix-session/config" \
             "$HOME/.cache/nix-session/data" \
             "$HOME/.cache/nix-session/cache"

    nix profile add "nixpkgs#$1" --profile "$SESSION_PROF" # install package to #SESSION_PROF

    BEFORE="${BEFORE:- }"
    local AFTER="" # binaries after install
    for f in "$SESSION_PROF/bin"/*; do
        [ -f "$f" ] && AFTER="$AFTER $(basename "$f")"
    done
    # local NEW_BINS=$(echo "$AFTER" | grep -Fxv -f <(echo "$BEFORE")) # new binaries from installation
    local NEW_BINS=""
    for bin in $AFTER; do
        FOUND=0
        for b in $BEFORE; do
            [ "$bin" = "$b" ] && FOUND=1
        done
        [ $FOUND -eq 0 ] && NEW_BINS="$NEW_BINS $bin"
    done

    # create wrappers only for new binaries
    for bin in $NEW_BINS; do
        local BIN_PATH="$SESSION_PROF/bin/$bin"
        local WRAPPER="$WRAPPERS_DIR/$bin"

        cat > "$WRAPPER" <<EOF
#!/bin/sh
export XDG_CONFIG_HOME="$HOME/.cache/nix-session/config"
export XDG_DATA_HOME="$HOME/.cache/nix-session/data"
export XDG_CACHE_HOME="$HOME/.cache/nix-session/cache"
exec "$BIN_PATH" "\$@"
EOF
        chmod +x "$WRAPPER"
    done

    # add wrapper directory to PATH if not already
    case ":$PATH:" in
        *":$WRAPPERS_DIR:"*) ;;
        *) export PATH="$WRAPPERS_DIR:$PATH" ;;
    esac

    echo "âœ… '$1' is now available in this session."
    echo "all configs/data/caches go to ~/.cache/nix-session/"
}

# add packages installed thru ins() to PATH of future shells
export PATH="$HOME/.cache/nix-session/wrappers:$PATH"

export PS1=\
'\fm.${LOGNAME} '\
'\fw.${{{PWD:/~/\~}##*/}:-$PWD}'\
"\fm.${SSH_CONNECTION:+@${HOSTNAME}}"\
"\fm \$\fd "

# yash
HISTFILE=${XDG_CACHE_HOME}/yash_history HISTSIZE=5000

# normally yash is more POSIX-compliant than /bin/sh :-)
sh() { yash --posix "$@"; }
yash() { command yash "$@"; }


if [ "$TERM" = "linux" ]; then
    echo -en "\e]P0000000" #black
    echo -en "\e]P8918f8f" #darkgrey
    echo -en "\e]P1e56f92" #darkred
    echo -en "\e]P9e56f92" #red
    echo -en "\e]P28cd7aa" #darkgreen
    echo -en "\e]PA8cd7aa" #green
    echo -en "\e]P3D7AF87" #brown
    echo -en "\e]PBe9967e" #yellow
    echo -en "\e]P479aaeb" #darkblue
    echo -en "\e]PC79aaeb" #blue
    echo -en "\e]P5c488ec" #darkmagenta
    echo -en "\e]PDc488ec" #magenta
    echo -en "\e]P67abce4" #darkcyan
    echo -en "\e]PE7abce4" #cyan
    echo -en "\e]P7daddee" #lightgrey
    echo -en "\e]PFdaddee" #white
    clear #for background artifacting
fi

[ -r ~/.cargo/env ] && . ~/.cargo/env
